---
title: "Projet"
author: "BENOLIEL"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(stargazer)
library(rdd) 
library(rddtools)
library(AER)
library(ggthemes)
library(gridExtra)

dvf_2023 <- dvf %>% filter(date_mutation==2023)
```

```{r}
bw_nearest_metro_distance <- rdd::IKbandwidth(dvf_2023$nearest_metro_distance, dvf_2023$prix_m2, cutpoint = 1000, verbose = T)
min_distance <- 1000 - bw_nearest_metro_distance
max_distance <- 1000 + bw_nearest_metro_distance

# Filtrer les individus dont la distance au métro se situe dans l'intervalle spécifié
df_filtered <- dvf_2023 %>%
  filter(nearest_metro_distance >= min_distance & nearest_metro_distance <= max_distance)

# Liste des variables numériques
numeric_vars <- c('prix_m2', 'valeur_fonciere', 'nombre_pieces_principales', "surface_reelle_bati")

plot_list <- list()

# Créer les boxplots pour chaque variable numérique
for (var in numeric_vars) {
  p <- ggplot(df_filtered, aes(x = as.factor(traite), y = .data[[var]], fill = as.factor(traite))) + 
    geom_boxplot(alpha = 0.6) + 
    scale_fill_manual(values = c("red", "blue")) + 
    labs(title = paste("Boxplot de", var), x = "Traite", y = var) +
    theme_minimal() +
    theme(legend.position = "none")
  
  plot_list[[var]] <- p  
}

combined_plot <- grid.arrange(grobs = plot_list, ncol = 2)
combined_plot

ggsave("png/boxplots_combines.png", combined_plot, width = 10, height = 8, dpi = 300)
```

```{r}
m1_prix_m2 <- lm(prix_m2 ~ nearest_metro_distance + traite + type_local + nombre_pieces_principales,
                 data = dvf_2023)

summary(m1_prix_m2)

min_distance <- 1000 - bw_nearest_metro_distance
max_distance <- 1000 + bw_nearest_metro_distance

m2_prix_m2 <- lm(prix_m2 ~ nearest_metro_distance +traite+ type_local + nombre_pieces_principales,
                 data = dvf_2023 %>%
  filter(nearest_metro_distance >= min_distance & nearest_metro_distance <= max_distance))

summary(m2_prix_m2)

min_distance <- 1000 - 2*bw_nearest_metro_distance
max_distance <- 1000 + 2*bw_nearest_metro_distance

m3_prix_m2 <- lm(prix_m2 ~ nearest_metro_distance + traite + type_local + nombre_pieces_principales,
                 data = dvf_2023 %>%
  filter(nearest_metro_distance >= min_distance & nearest_metro_distance <= max_distance))

summary(m3_prix_m2)
```
```{r}
mod.list <- list(m1_prix_m2, m2_prix_m2, m3_prix_m2)
stargazer(title = "Full regression models",
          type="text",
          header = F,
          mod.list, 
          model.names = F,
          omit.stat = c("rsq","ser","f"),
          column.labels = c("échantillon complet", "Optimal Bandwidth", "Double Bandwidth")) 
```

